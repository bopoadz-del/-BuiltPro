name: Regenerate Frontend Lockfile

on:
  # Manual trigger
  workflow_dispatch:
  # Run weekly to keep dependencies fresh
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM
  # Run when package.json changes
  push:
    branches:
      - main
      - develop
    paths:
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'frontend/package.json'

jobs:
  validate-lockfile:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Validate lockfile consistency
        run: |
          # Check if package.json and package-lock.json are in sync
          npm ci --dry-run 2>&1 | tee validation.log
          
          if grep -i "error\|EBADPLATFORM\|ECONFLICT\|ERESOLVE" validation.log; then
            echo "Lockfile validation failed!"
            exit 1
          fi
          
          echo "Lockfile is valid and consistent with package.json"

      - name: Audit dependencies
        run: |
          npm audit --audit-level=moderate || true
          
          # Fail on critical vulnerabilities
          critical_count=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.critical // 0' || echo "0")
          if [ "$critical_count" -gt "0" ]; then
            echo "Critical vulnerabilities found: $critical_count"
            npm audit --audit-level=critical
            exit 1
          fi

  regenerate-lockfile:
    runs-on: ubuntu-latest
    needs: validate-lockfile
    # Only run on manual trigger or if validation fails
    if: ${{ failure() || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Regenerate lockfile
        working-directory: ./frontend
        run: |
          # Backup existing lockfile
          cp package-lock.json package-lock.json.backup
          
          # Remove old lockfile and node_modules
          rm -rf node_modules package-lock.json
          
          # Regenerate with latest compatible versions
          npm install
          
          # Verify installation works
          npm ci
          
          # Run build to verify
          npm run build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(frontend): regenerate package-lock.json'
          title: 'chore(frontend): regenerate package-lock.json'
          body: |
            ## Lockfile Regeneration
            
            This PR regenerates the frontend `package-lock.json` to:
            - Update dependencies to latest compatible versions
            - Fix any lockfile inconsistencies
            - Address security vulnerabilities
            
            ### Changes
            - Regenerated `frontend/package-lock.json`
            - Verified build passes
            - Audited for security vulnerabilities
            
            ### Verification
            - [ ] CI passes
            - [ ] Build successful
            - [ ] No critical vulnerabilities
            
            Auto-generated by GitHub Actions.
          branch: chore/regenerate-frontend-lockfile
          delete-branch: true
          add-paths: |
            frontend/package-lock.json

  security-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          npm audit --json > audit-report.json || true
          
          # Check for high/critical vulnerabilities
          high_count=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
          critical_count=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
          
          echo "Vulnerabilities found:"
          echo "  High: $high_count"
          echo "  Critical: $critical_count"
          
          if [ "$critical_count" -gt "0" ]; then
            echo "::error::Critical vulnerabilities detected!"
            npm audit --audit-level=critical
            exit 1
          fi
          
          if [ "$high_count" -gt "5" ]; then
            echo "::warning::More than 5 high severity vulnerabilities found"
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: frontend/audit-report.json
          retention-days: 30
